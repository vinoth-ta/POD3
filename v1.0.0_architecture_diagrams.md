# STTM-to-Notebook Generator v1.0.0: Architecture Diagrams

## 1. Sequence Diagram

```mermaid
sequenceDiagram
    participant Client as Client Application
    participant API3 as API3 Orchestrator
    participant API1 as API1 JSON Converter
    participant API2 as API2 Notebook Generator
    participant LLM as Azure OpenAI LLM
    participant DB as Database/Storage

    Client->>API3: POST /from-sttm-generate-notebook
    Note over Client,API3: STTM Excel + Metadata
    
    API3->>API1: Call orchestrate_json_sttm()
    Note over API3,API1: Pass STTM files and metadata
    
    API1->>API1: Parse Excel STTM file
    API1->>API1: Basic validation
    API1->>LLM: Generate JSON mapping
    Note over API1,LLM: Prompt with STTM data
    
    LLM-->>API1: Return JSON response
    API1->>API1: Basic JSON validation
    API1->>API1: Semantic validation (if needed)
    
    alt Validation Failed
        API1->>LLM: Retry with feedback
        LLM-->>API1: Updated JSON response
    end
    
    API1-->>API3: Return JSON STTM + Metadata
    Note over API1,API3: Structured JSON mapping
    
    API3->>API2: Call generate_silver_notebook()
    Note over API3,API2: Pass JSON STTM + Notebook metadata
    
    API2->>API2: Load templates
    API2->>LLM: Generate SQL code
    Note over API2,LLM: Prompt with JSON STTM
    
    LLM-->>API2: Return SQL response
    API2->>API2: Validate SQL syntax
    API2->>API2: Generate notebook content
    
    API2-->>API3: Return notebook data
    Note over API2,API3: Complete Databricks notebook
    
    API3-->>Client: Return success response
    Note over API3,Client: Notebook + Status
```

## 2. Process Flow Diagram

```mermaid
flowchart TD
    A[Start: Client Request] --> B[API3: Receive Request]
    B --> C[API3: Extract STTM Files & Metadata]
    
    C --> D[API1: Process STTM Files]
    D --> E[API1: Parse Excel Data]
    E --> F[API1: Basic Validation]
    
    F --> G{Validation Pass?}
    G -->|No| H[API1: Return Error]
    G -->|Yes| I[API1: Prepare LLM Prompt]
    
    I --> J[LLM: Generate JSON STTM]
    J --> K[API1: Receive JSON Response]
    K --> L[API1: Validate JSON Structure]
    
    L --> M{JSON Valid?}
    M -->|No| N[API1: Retry Generation]
    N --> J
    M -->|Yes| O[API1: Semantic Validation]
    
    O --> P{Semantic Valid?}
    P -->|No| Q[API1: Retry with Feedback]
    Q --> J
    P -->|Yes| R[API1: Return JSON STTM]
    
    R --> S[API3: Prepare Notebook Request]
    S --> T[API2: Load Templates]
    T --> U[API2: Generate SQL Prompt]
    U --> V[LLM: Generate SQL Code]
    
    V --> W[API2: Receive SQL Response]
    W --> X[API2: Validate SQL Syntax]
    X --> Y{SQL Valid?}
    Y -->|No| Z[API2: Retry SQL Generation]
    Z --> V
    Y -->|Yes| AA[API2: Generate Notebook]
    
    AA --> BB[API2: Return Notebook]
    BB --> CC[API3: Format Response]
    CC --> DD[End: Return to Client]
    
    style A fill:#e1f5fe
    style DD fill:#c8e6c9
    style H fill:#ffcdd2
    style J fill:#fff3e0
    style V fill:#fff3e0
    style LLM fill:#f3e5f5
```

## 3. System Architecture Diagram

```mermaid
graph TB
    subgraph "Client Layer"
        A[Client Application]
    end
    
    subgraph "API Gateway Layer"
        B[API3 Orchestrator<br/>Main Controller]
    end
    
    subgraph "Processing Layer"
        C[API1 JSON Converter<br/>STTM Processing]
        D[API2 Notebook Generator<br/>Code Generation]
    end
    
    subgraph "LLM Layer"
        E[Azure OpenAI<br/>GPT-4o Model]
    end
    
    subgraph "Template Layer"
        F[Jinja2 Templates<br/>Silver Layer]
        G[Jinja2 Templates<br/>Gold Layer]
    end
    
    subgraph "Validation Layer"
        H[Basic Validation<br/>Schema Check]
        I[Semantic Validation<br/>Business Rules]
        J[SQL Validation<br/>Syntax Check]
    end
    
    subgraph "Storage Layer"
        K[File System<br/>STTM Files]
        L[Database<br/>Metadata]
        M[Output Storage<br/>Generated Notebooks]
    end
    
    subgraph "Logging Layer"
        N[Log Handler<br/>Session Tracking]
        O[Audit Framework<br/>Process Logging]
    end
    
    %% Connections
    A --> B
    B --> C
    B --> D
    C --> E
    D --> E
    C --> F
    D --> G
    C --> H
    C --> I
    D --> J
    C --> K
    B --> L
    D --> M
    C --> N
    D --> O
    
    %% Styling
    style A fill:#e3f2fd
    style B fill:#bbdefb
    style C fill:#c8e6c9
    style D fill:#c8e6c9
    style E fill:#f3e5f5
    style F fill:#fff3e0
    style G fill:#fff3e0
    style H fill:#ffecb3
    style I fill:#ffecb3
    style J fill:#ffecb3
    style K fill:#f1f8e9
    style L fill:#f1f8e9
    style M fill:#f1f8e9
    style N fill:#e0f2f1
    style O fill:#e0f2f1
```

## 4. Component Interaction Details

### API3 Orchestrator (Main Controller)
- **Role**: Central coordinator for the entire process
- **Responsibilities**: 
  - Request validation and routing
  - Error handling and response formatting
  - Session management and logging
  - Integration between API1 and API2

### API1 JSON Converter (STTM Processing)
- **Role**: Converts Excel STTM files to structured JSON
- **Responsibilities**:
  - Excel file parsing and validation
  - LLM prompt generation for JSON creation
  - JSON structure validation
  - Semantic validation with business rules
  - Error recovery and retry logic

### API2 Notebook Generator (Code Generation)
- **Role**: Generates Databricks ETL notebooks
- **Responsibilities**:
  - Template loading and customization
  - SQL code generation via LLM
  - Notebook assembly and formatting
  - SQL syntax validation
  - Output file generation

### Azure OpenAI LLM Layer
- **Model**: GPT-4o
- **Primary Functions**:
  - JSON STTM generation from Excel data
  - SQL code generation from JSON mapping
  - Semantic understanding and validation
  - Error correction and improvement

### Validation Framework
- **Multi-layer validation**:
  - Schema validation (JSON structure)
  - Semantic validation (business logic)
  - SQL validation (syntax and logic)
  - Data quality validation

### Template System
- **Jinja2-based templates**:
  - Silver layer transformation templates
  - Gold layer transformation templates
  - Project-specific customizations
  - Standardized output formatting

---

*Architecture diagrams for STTM-to-Notebook Generator v1.0.0*
*Generated on July 29, 2025* 