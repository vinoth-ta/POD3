{"success":true,"message":"Notebook generated successfully.","notebook_id":"TODO","notebook_name":"generated_notebook.py","data":"# Databricks notebook source\n# MAGIC %md\n# MAGIC ## Overview\n# MAGIC This code is generated by FDN Code Genaration Tool.The purpose of this notebook is to transform and ingest data from Bronze Layer to Silver Layer for table(s) XTNElectricityBasedEmission.\n# MAGIC\n# MAGIC ##### Project Name: <Project_Name>\n# MAGIC\n# MAGIC ### Version History\n# MAGIC\n# MAGIC | S. No | Author | Date | Desc |\n# MAGIC | ------ | ------ | ------ | ------ |\n# MAGIC | 1. | vinoth.premkumar | 2025-07-28 | <Description> |\n# MAGIC\n# MAGIC ### Source and Target Info\n# MAGIC\n# MAGIC | Source DB  | Source Table |  Target DB | Target Table |\n# MAGIC |------|------ |--------|--------|\n# MAGIC |<Bronze Schema> |<Bronze Table>| <Silver Schema> | XTNElectricityBasedEmission |\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Importing Necessary Packages\n\n# COMMAND ----------\n\nimport re\nimport json\nfrom pyspark.sql.functions import *\nfrom datetime import datetime\nfrom cdo_audit_framework_wd_la import audit_utilities as au\nfrom pyspark.sql.types import StringType\nfrom typing import Final\nfrom cdo_dq_framework import dqm_framework\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Getting values from widgets\n\n# COMMAND ----------\n\ndbutils.widgets.text(\"InputParam\", \"{}\", \"InputParam\")\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Running Utility Notebook\n\n# COMMAND ----------\n\n# MAGIC %run /data_framework/release/di_framework/common_utility\n\n# COMMAND ----------\n\n# initialising domain utilities\ndm_utils = FrameworkDomainUtils()\n\n# COMMAND ----------\n\ntry:\n    widgetParams = dm_utils.get_silver_notebook_arguments(getArgument(\"InputParam\"))\nexcept Exception as e:\n    widgetParams = dm_utils.parse_input_json(getArgument(\"InputParam\"))\n    # Additional Parameters\n    widgetParams[\"load_ts\"] = datetime.utcnow().strftime(\"%Y-%m-%d %H:%M:%S.%f\")[:-3]\n    widgetParams[\"full_notebook_path\"] = dbutils.notebook.entry_point.getDbutils().notebook().getContext().notebookPath().get()\n    widgetParams[\"notebook_job_url\"] = au.get_notebook_job_url()\n    dm_utils.dm_utils.post_audit_log(\n        status_cd_failure,\n        f\"Silver Notebook process failed owing to below reason:-\\n{e}\",\n        widgetParams\n    )\n    raise e\n\n# COMMAND ----------\n\nprint(f\"[INFO] Widget Parameters :\\n{widgetParams}\")\n\n# COMMAND ----------\n\n# Declaring Variables\ntarget_table_nm = widgetParams[\"SilverTableName\"]\ntarget_db_nm = widgetParams.get(\"SilverDBDict\")[target_table_nm][\"database_name\"]\nload_ts = widgetParams[\"load_ts\"]\n\n#Setting default init variables below if present in STTM\n<default_init_variables>\n    \n# Audit Logging\nstatus_cd_initial=\"I\"\nstatus_cd_progess=\"P\"\nstatus_cd_success=\"S\"\nstatus_cd_failure=\"F\"\nwidgetParams[\"full_notebook_path\"] = dbutils.notebook.entry_point.getDbutils().notebook().getContext().notebookPath().get()\nwidgetParams[\"notebook_job_url\"] = au.get_notebook_job_url()\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Audit Logic - Initialization\n\n# COMMAND ----------\n\ndm_utils.post_audit_log(\n    status_cd_initial,\n    f\"Silver Notebook process initialized for {target_table_nm} table(s) of schema {target_db_nm}\",\n    widgetParams,\n)\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Bronze Data Deduplication if applicable\n\n# COMMAND ----------\n\n\n# COMMAND ----------\n# The below code snippet is AI-Generated, please review for accuracy ...\n\n\n# COMMAND ----------\ntry:\n    transform_sql_query_dict = {\n        target_table_nm: {\n            \"sql\": \"\"\"SELECT \n                Concat(a.ReportingEntityId, '|', CAST(a.ReportingPeriod AS TIMESTAMP), '|', a.Ref) AS ElectricityEmissionUniqueId,\n                a.CS_EntityRef AS ReportingEntityId,\n                CAST(a.ReportingPeriod AS TIMESTAMP) AS PeriodStartDateTime,\n                'Default Value' AS ReportingEntityTypeName,\n                a.Frequency_FK_Id AS FrequencyId,\n                b.FuelTypeId AS FuelTypeId,\n                a.Ref AS SustainProcessCode,\n                c.StandardDisclosureId AS StandardDisclosureId,\n                a.Indicator_FK_Id AS SustainProcessId,\n                'Default Value' AS MasterDataSystemId,\n                d.Iso2LetterCountryCode AS CountryIso2Code,\n                CASE \n                    WHEN COALESCE(a.ValueNumber, a.ValueText) < 0 THEN NULL \n                    ELSE COALESCE(a.ValueNumber, a.ValueText) \n                END AS Co2EEmissionUnitQuantity,\n                CONCAT(a.CS_UnitSearch_FK_Id, e.CountryCode) AS Co2EEmissionUnitOfMeasureCode,\n                'Default Value' AS XTNDFSystemId,\n                'Default Value' AS XTNDFReportingUnitId,\n                CURRENT_TIMESTAMP AS XTNCreatedTime,\n                'ETL_USER' AS XTNCreatedById,\n                CURRENT_TIMESTAMP AS XTNUpdatedTime,\n                'ETL_USER' AS XTNUpdatedById\n            FROM {BronzeDBName}.{BronzeTblName} a\n            LEFT JOIN fdn_csr.fueltype b ON a.FuelTypeId = b.FuelTypeId\n            LEFT JOIN fdn_csr.xtnenvironmentalsocialgovernancestandarddisclosuretype c ON c.StandardDisclosureName = a.ReportingCategoryName\n            LEFT JOIN fdn_masterData_public.Country d ON a.CS_CountryName = d.CountryName\n            LEFT JOIN fdn_masterData_public.emplyee e ON e.CountryName = a.CS_CountryName\n            WHERE CAST(a.ReportingPeriod AS TIMESTAMP) IS NOT NULL\n            QUALIFY ROW_NUMBER() OVER (PARTITION BY a.CS_EntityRef ORDER BY CAST(a.ZTIMESTAMP AS BIGINT) DESC) = 1\n            \"\"\".format(target_db_name=target_db_nm, **widgetParams),\n            \"merge_key\": \"ElectricityEmissionUniqueId\",\n            \"partition_columns\": \"ReportingEntityId, PeriodStartDateTime\",\n            \"merge_type\": \"upsert\",\n            \"format_type\": \"delta\",\n            \"output_directory_name\": f\"silver/database/{target_table_nm}\"\n        }\n    }\nexcept Exception as e:\n    dm_utils.post_audit_log(\n        status_cd_failure,\n        f\"Silver Notebook process failed for {target_table_nm} table(s) of schema {target_db_nm} owing to below reason:-\\n{e}\",\n        widgetParams,\n    )\n    raise e\n\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Validating input DataFrame Schema and target Silver Table Schema (column name and datatypes)\n\n# COMMAND ----------\n\ntry:\n    dm_utils.silver_table_columns_match(widgetParams, transform_sql_query_dict)\nexcept Exception as e:\n    raise e   \n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Executing Silver DQ rules\n\n# COMMAND ----------\n\n# Setting flags to enable DQ checks\nwidgetParams[\"dq_dataset_name\"] = widgetParams[\"system_name\"]\ndq_enable_flag = IsDqConfigured(widgetParams, 'silver')\n\n# COMMAND ----------\n\ntry:\n    if dq_enable_flag:\n        print(f\"Silver DQ validation is started for the table {target_table_nm} {load_ts}\")\n        dm_utils.silver_table_dq_rules_enablement(target_table_nm, widgetParams)\n        print(f\"Silver DQ validation is completed for the table {target_table_nm} {load_ts}\")\n\nexcept Exception as e:\n    dm_utils.post_audit_log(\n        status_cd_failure,\n        f\"Silver Notebook DQ process failed for {target_table_nm} table(s) of schema {target_db_nm} owing to below reason:-\\n{e}\",\n        widgetParams,\n    )\n    raise e\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Ingesting transformed data into Silver table\n\n# COMMAND ----------\n\ntry:\n    print(f\"Starting silver ingestion for {target_table_nm}\")\n    load_child_silver_tbls(transform_sql_query_dict, widgetParams)\n    print(f\"Silver ingestion completed for {target_table_nm}\")\n    dm_utils.post_audit_log(\n        status_cd_success,\n        f\"Silver Notebook process completed for {target_table_nm} table(s) of schema {target_db_nm} successfully\",\n        widgetParams,\n    )\n\nexcept Exception as e:\n    dm_utils.post_audit_log(\n        status_cd_failure,\n        f\"Silver Notebook process failed for {target_table_nm} table(s) of schema {target_db_nm} owing to below reason:-\\n{e}\",\n        widgetParams,\n    )\n    raise e\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Get Load Statistics\n\n# COMMAND ----------\n\nresult_dict = dm_utils.get_statistics_of_data_loaded(target_db_nm+\".\"+target_table_nm, widgetParams[\"load_ts\"])\nprint(result_dict)\n\n# COMMAND ----------\n\n# MAGIC %md\n# MAGIC ### Returning Control to Parent Notebook\n\n# COMMAND ----------\n\ntry:\n    dbutils.notebook.exit(\"success\")\n\nexcept Exception as e:\n    if str(e) == \"success\":\n        print(\"Catching unintended Exception raised due to dbutils.notebook.exit with msg -\", e)\n        dbutils.notebook.exit(\"success\")  # This will finally return the control to the parent notebook\n    else:\n        raise e"}