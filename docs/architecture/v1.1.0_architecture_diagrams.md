# STTM-to-Notebook Generator v1.1.0: Architecture Diagrams

## 1. Sequence Diagram

```mermaid
sequenceDiagram
    participant Client as Client Application
    participant API3 as API3 Orchestrator
    participant API1 as API1 Optimized Converter
    participant API2 as API2 Notebook Generator
    participant LLM as Azure OpenAI LLM
    participant Validator as Smart Validator
    participant Cache as Token Cache

    Client->>API3: POST /from-sttm-generate-notebook
    Note over Client,API3: STTM Excel + Metadata
    
    API3->>API1: Call orchestrate_json_sttm()
    Note over API3,API1: Pass STTM files and metadata
    
    API1->>API1: Smart Excel parsing
    API1->>Validator: Multi-layer validation
    Note over Validator: Schema + Business Rules
    
    Validator-->>API1: Validation result
    API1->>Cache: Check token optimization
    Cache-->>API1: Optimized prompt
    
    API1->>LLM: Generate JSON mapping
    Note over API1,LLM: Optimized prompt with feedback loop
    
    LLM-->>API1: Return JSON response
    API1->>Validator: Smart JSON validation
    Validator-->>API1: Validation with suggestions
    
    alt Validation Failed
        API1->>API1: Apply feedback loop
        API1->>LLM: Retry with improved prompt
        LLM-->>API1: Enhanced JSON response
    end
    
    API1-->>API3: Return optimized JSON STTM
    Note over API1,API3: Enhanced JSON with metadata
    
    API3->>API2: Call generate_silver_notebook()
    Note over API3,API2: Pass optimized JSON STTM
    
    API2->>API2: Load enhanced templates
    API2->>LLM: Generate optimized SQL code
    Note over API2,LLM: Advanced prompt engineering
    
    LLM-->>API2: Return enhanced SQL response
    API2->>Validator: Advanced SQL validation
    Validator-->>API2: SQL quality assessment
    
    API2->>API2: Generate enhanced notebook
    Note over API2: With improved structure and quality
    
    API2-->>API3: Return optimized notebook
    Note over API2,API3: Enhanced Databricks notebook
    
    API3-->>Client: Return success response
    Note over API3,Client: Optimized notebook + metrics
```

## 2. Process Flow Diagram

```mermaid
flowchart TD
    A[Start: Client Request] --> B[API3: Receive Request]
    B --> C[API3: Extract STTM Files & Metadata]
    
    C --> D[API1: Smart STTM Processing]
    D --> E[API1: Optimized Excel Parsing]
    E --> F[API1: Multi-layer Validation]
    
    F --> G{Smart Validation Pass?}
    G -->|No| H[API1: Return Detailed Error]
    G -->|Yes| I[API1: Token Optimization]
    
    I --> J[API1: Generate Optimized Prompt]
    J --> K[LLM: Generate Enhanced JSON STTM]
    K --> L[API1: Smart JSON Validation]
    
    L --> M{Enhanced JSON Valid?}
    M -->|No| N[API1: Apply Feedback Loop]
    N --> O[API1: Improve Prompt]
    O --> K
    M -->|Yes| P[API1: Quality Assessment]
    
    P --> Q{Quality Score > Threshold?}
    Q -->|No| R[API1: Enhancement Iteration]
    R --> K
    Q -->|Yes| S[API1: Return Optimized JSON]
    
    S --> T[API3: Prepare Enhanced Request]
    T --> U[API2: Load Advanced Templates]
    U --> V[API2: Generate Optimized SQL Prompt]
    V --> W[LLM: Generate Enhanced SQL Code]
    
    W --> X[API2: Advanced SQL Validation]
    X --> Y{Enhanced SQL Valid?}
    Y -->|No| Z[API2: SQL Enhancement Loop]
    Z --> W
    Y -->|Yes| AA[API2: Quality Optimization]
    
    AA --> BB[API2: Generate Enhanced Notebook]
    BB --> CC[API2: Return Optimized Notebook]
    CC --> DD[API3: Format Enhanced Response]
    DD --> EE[End: Return to Client]
    
    style A fill:#e1f5fe
    style EE fill:#c8e6c9
    style H fill:#ffcdd2
    style K fill:#fff3e0
    style W fill:#fff3e0
    style LLM fill:#f3e5f5
    style Validator fill:#e8f5e8
    style Cache fill:#fff8e1
```

## 3. System Architecture Diagram

```mermaid
graph TB
    subgraph "Client Layer"
        A[Client Application]
    end
    
    subgraph "API Gateway Layer"
        B[API3 Orchestrator<br/>Enhanced Controller]
    end
    
    subgraph "Optimized Processing Layer"
        C[API1 Optimized Converter<br/>Smart STTM Processing]
        D[API2 Enhanced Generator<br/>Advanced Code Generation]
    end
    
    subgraph "Enhanced LLM Layer"
        E[Azure OpenAI<br/>GPT-4o Model]
        F[Token Optimization<br/>Cache Management]
    end
    
    subgraph "Advanced Template Layer"
        G[Enhanced Jinja2 Templates<br/>Silver Layer]
        H[Enhanced Jinja2 Templates<br/>Gold Layer]
        I[Project-Specific Templates<br/>Custom Domains]
    end
    
    subgraph "Smart Validation Layer"
        J[Multi-layer Validation<br/>Schema + Business Rules]
        K[Semantic Validation<br/>Enhanced Business Logic]
        L[Advanced SQL Validation<br/>Quality Assessment]
        M[Feedback Loop Engine<br/>Continuous Improvement]
    end
    
    subgraph "Performance Layer"
        N[Token Cache<br/>Optimization Engine]
        O[Smart Parsing<br/>Excel Optimization]
        P[Quality Metrics<br/>Performance Tracking]
    end
    
    subgraph "Enhanced Storage Layer"
        Q[Optimized File System<br/>STTM Files]
        R[Enhanced Database<br/>Metadata + Metrics]
        S[Advanced Output Storage<br/>Generated Notebooks]
    end
    
    subgraph "Advanced Logging Layer"
        T[Enhanced Log Handler<br/>Session + Performance]
        U[Advanced Audit Framework<br/>Quality Metrics]
        V[Performance Monitor<br/>Real-time Analytics]
    end
    
    %% Connections
    A --> B
    B --> C
    B --> D
    C --> E
    D --> E
    C --> F
    D --> F
    C --> G
    D --> H
    D --> I
    C --> J
    C --> K
    D --> L
    C --> M
    D --> M
    C --> N
    C --> O
    C --> P
    D --> P
    C --> Q
    B --> R
    D --> S
    C --> T
    D --> U
    B --> V
    
    %% Styling
    style A fill:#e3f2fd
    style B fill:#bbdefb
    style C fill:#c8e6c9
    style D fill:#c8e6c9
    style E fill:#f3e5f5
    style F fill:#f3e5f5
    style G fill:#fff3e0
    style H fill:#fff3e0
    style I fill:#fff3e0
    style J fill:#ffecb3
    style K fill:#ffecb3
    style L fill:#ffecb3
    style M fill:#e8f5e8
    style N fill:#fff8e1
    style O fill:#fff8e1
    style P fill:#fff8e1
    style Q fill:#f1f8e9
    style R fill:#f1f8e9
    style S fill:#f1f8e9
    style T fill:#e0f2f1
    style U fill:#e0f2f1
    style V fill:#e0f2f1
```

## 4. Enhanced Component Interaction Details

### API3 Orchestrator (Enhanced Controller)
- **Role**: Advanced coordinator with performance optimization
- **Responsibilities**: 
  - Smart request validation and routing
  - Advanced error handling and recovery
  - Performance monitoring and metrics
  - Enhanced session management
  - Quality assessment and feedback

### API1 Optimized Converter (Smart STTM Processing)
- **Role**: Advanced Excel STTM processing with optimization
- **Responsibilities**:
  - Smart Excel parsing with optimization
  - Multi-layer validation with feedback
  - Token optimization and caching
  - Enhanced LLM prompt engineering
  - Advanced JSON structure validation
  - Quality scoring and improvement loops
  - Performance metrics tracking

### API2 Enhanced Generator (Advanced Code Generation)
- **Role**: Advanced notebook generation with quality optimization
- **Responsibilities**:
  - Enhanced template loading and customization
  - Advanced SQL code generation via LLM
  - Quality-optimized notebook assembly
  - Advanced SQL validation and assessment
  - Performance-optimized output generation
  - Quality metrics and improvement tracking

### Enhanced Azure OpenAI LLM Layer
- **Model**: GPT-4o with optimization
- **Primary Functions**:
  - Optimized JSON STTM generation
  - Enhanced SQL code generation
  - Advanced semantic understanding
  - Quality-driven error correction
  - Performance-optimized responses

### Smart Validation Framework
- **Multi-layer intelligent validation**:
  - Advanced schema validation with suggestions
  - Enhanced semantic validation with business logic
  - Quality-driven SQL validation
  - Performance-based data quality assessment
  - Continuous improvement feedback loops

### Enhanced Template System
- **Advanced Jinja2-based templates**:
  - Performance-optimized Silver layer templates
  - Quality-enhanced Gold layer templates
  - Domain-specific customizations
  - Advanced output formatting with quality metrics

### Performance Optimization Layer
- **Token optimization and caching**:
  - Smart token usage optimization
  - Response caching for efficiency
  - Performance metrics tracking
  - Quality-driven improvements

### Advanced Monitoring and Analytics
- **Real-time performance tracking**:
  - Token usage analytics
  - Processing time optimization
  - Quality metrics assessment
  - Performance trend analysis

---

*Enhanced architecture diagrams for STTM-to-Notebook Generator v1.1.0*
*Generated on July 29, 2025* 